<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Duplicate Alumni - Admin</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="adminstyle.css">
    <style>
        .duplicate-group {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .duplicate-record {
            background: white;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .duplicate-record.selected {
            border-color: #004AAD;
            background: #e8f4ff;
        }
        .record-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .merge-btn {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .merge-btn:hover {
            background: #218838;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 10px;
        }
        .delete-btn:hover {
            background: #c82333;
        }
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <header class="admin-header">
        <div class="header-left">
            <div class="logo-circle small"><img src="logo/Blue%20%26%20Orange%20Circle%20Illustrative%20Education%20Logo.jpg" class="nav-logo" alt="logo" onerror="this.onerror=null;this.src='logo/557536151_1257403522824074_2017646524872962832_n.png'"></div>
        </div>
        <div class="header-center">NEXT STEP</div>
        <div class="header-right"><button class="user-icon">üë§</button></div>
    </header>

    <div class="admin-layout">
        <aside class="admin-sidebar">
            <nav>
                <ul>
                    <li><a href="homepage.html"><span class="home-ico">üè†</span> Dashboard</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-main">
            <a class="back-link" href="homepage.html">‚Üê</a>
            <div class="page-card">
                <h2>Manage Duplicate Alumni Records</h2>
                
                <div id="statusMessage"></div>

                <div style="margin: 20px 0;">
                    <button onclick="scanForDuplicates()" class="merge-btn">Scan for Duplicates</button>
                    <p style="color: #666; margin-top: 10px;">This will search for alumni with the same email or student number.</p>
                </div>

                <div id="duplicatesContainer">
                    <p style="color: #999;">Click "Scan for Duplicates" to begin.</p>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="alumni-duplicate-prevention.js"></script>
    <script src="logout.js"></script>
    <script>
        async function scanForDuplicates() {
            const container = document.getElementById('duplicatesContainer');
            const statusMsg = document.getElementById('statusMessage');
            
            container.innerHTML = '<p>Scanning for duplicates...</p>';
            statusMsg.innerHTML = '';

            try {
                const duplicates = await window.alumniUtils.findDuplicateAlumni();
                
                if (duplicates.length === 0) {
                    container.innerHTML = '<p style="color: #28a745; font-weight: 600;">‚úì No duplicates found! All alumni records are unique.</p>';
                    return;
                }

                container.innerHTML = `<h3>Found ${duplicates.length} duplicate group(s):</h3>`;
                
                duplicates.forEach((group, groupIndex) => {
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'duplicate-group';
                    groupDiv.innerHTML = `
                        <h4>Duplicate Group ${groupIndex + 1}</h4>
                        <p><strong>Email:</strong> ${group[0].email || 'N/A'} | <strong>Student Number:</strong> ${group[0].student_number || 'N/A'}</p>
                    `;

                    group.forEach((record, recordIndex) => {
                        const recordDiv = document.createElement('div');
                        recordDiv.className = 'duplicate-record';
                        recordDiv.innerHTML = `
                            <div class="record-info">
                                <div><strong>Name:</strong> ${record.full_name || 'N/A'}</div>
                                <div><strong>Email:</strong> ${record.email || 'N/A'}</div>
                                <div><strong>Student #:</strong> ${record.student_number || 'N/A'}</div>
                                <div><strong>Degree:</strong> ${record.degree || 'N/A'}</div>
                                <div><strong>Created:</strong> ${new Date(record.created_at).toLocaleDateString()}</div>
                            </div>
                            <button class="delete-btn" onclick="deleteRecord('${record.id}', ${groupIndex})">Delete This Record</button>
                        `;
                        groupDiv.appendChild(recordDiv);
                    });

                    container.appendChild(groupDiv);
                });

            } catch (error) {
                console.error('Error scanning duplicates:', error);
                statusMsg.innerHTML = `<div class="status-message status-error">Error: ${error.message}</div>`;
            }
        }

        async function deleteRecord(recordId, groupIndex) {
            if (!confirm('Are you sure you want to delete this alumni record? This cannot be undone.')) {
                return;
            }

            const statusMsg = document.getElementById('statusMessage');

            try {
                const { error } = await window.supabase
                    .from('alumni_profiles')
                    .delete()
                    .eq('id', recordId);

                if (error) throw error;

                statusMsg.innerHTML = '<div class="status-message status-success">‚úì Record deleted successfully!</div>';
                
                // Rescan after 1 second
                setTimeout(scanForDuplicates, 1000);

            } catch (error) {
                console.error('Error deleting record:', error);
                statusMsg.innerHTML = `<div class="status-message status-error">Error deleting record: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>
