<!-- CAREER OVERVIEW CHART - Copy this section into alumni/profile.html -->

<section class="career-overview-section">
    <div class="overview-container">
        <h2>Your Career Overview</h2>
        
        <div class="career-stats-display">
            <div class="stat-box">
                <div class="stat-label">Total Submissions</div>
                <div class="stat-value" id="alumniCareerTotal">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Employment Rate</div>
                <div class="stat-value" id="alumniEmployedPercent">0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Mentorship Open</div>
                <div class="stat-value" id="alumniMentorshipPercent">0%</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Top Industry</div>
                <div class="stat-value" id="alumniTopIndustry">—</div>
            </div>
        </div>

        <div class="career-chart-section">
            <h3>Career Status Breakdown</h3>
            <div class="chart-wrapper">
                <div class="career-chart" id="alumniCareerChart">
                    <div class="chart-placeholder">Loading career data...</div>
                </div>
                <div class="chart-legend" id="alumniChartLegend"></div>
            </div>
        </div>
    </div>
</section>

<script>
    // Load career overview data from Supabase
    async function loadAlumniCareerOverview() {
        try {
            if (!window.supabase || !window.supabase.from) {
                console.warn('Supabase not loaded');
                return;
            }

            const { data, error } = await window.supabase
                .from('career_info')
                .select('job_status, industry, mentorship');

            if (error) {
                console.error('Error fetching career data:', error);
                return;
            }

            const total = data.length;
            const statusCounts = {};
            const industryCounts = {};
            let employedCount = 0;
            let mentorshipCount = 0;

            const normalizeStatus = (raw) => {
                const s = (raw || '').trim().toLowerCase();
                if (!s) return 'Other';
                if (s.includes('self')) return 'Self-Employed';
                if (s.includes('free')) return 'Freelancer';
                if (s.includes('unemploy')) return 'Unemployed';
                if (s.includes('student')) return 'Student';
                if (s.includes('career')) return 'Career Break';
                if (s.includes('employ')) return 'Employed';
                return (raw || '').trim() || 'Other';
            };

            data.forEach(d => {
                const normStatus = normalizeStatus(d.job_status);
                statusCounts[normStatus] = (statusCounts[normStatus] || 0) + 1;

                if (['Employed', 'Self-Employed', 'Freelancer'].includes(normStatus)) {
                    employedCount++;
                }

                if ((d.mentorship || '').trim().toLowerCase() === 'yes') {
                    mentorshipCount++;
                }

                const key = (d.industry || '').trim();
                if (key) {
                    industryCounts[key] = (industryCounts[key] || 0) + 1;
                }
            });

            const topIndustry = Object.entries(industryCounts).sort((a, b) => b[1] - a[1])[0] || ['—', 0];
            const employedPct = total ? Math.round((employedCount / total) * 100) : 0;
            const mentorshipPct = total ? Math.round((mentorshipCount / total) * 100) : 0;

            // Update stats
            document.getElementById('alumniCareerTotal').textContent = total;
            document.getElementById('alumniEmployedPercent').textContent = `${employedPct}%`;
            document.getElementById('alumniMentorshipPercent').textContent = `${mentorshipPct}%`;
            document.getElementById('alumniTopIndustry').textContent = topIndustry[0] || '—';

            // Render chart
            renderAlumniCareerChart(statusCounts, total);

        } catch (err) {
            console.error('loadAlumniCareerOverview error:', err);
        }
    }

    // Render vertical bar chart
    function renderAlumniCareerChart(statusCounts, total) {
        const container = document.getElementById('alumniCareerChart');
        const legendContainer = document.getElementById('alumniChartLegend');
        
        if (!container) return;

        container.innerHTML = '';
        if (legendContainer) legendContainer.innerHTML = '';

        if (!total) {
            container.innerHTML = '<div class="chart-placeholder">No career data available yet.</div>';
            return;
        }

        const order = ['Employed', 'Self-Employed', 'Freelancer', 'Unemployed', 'Student', 'Career Break', 'Other'];
        const colors = [
            'linear-gradient(to top, #004AAD, #0066cc)',
            'linear-gradient(to top, #2e6edc, #5b8ee0)',
            'linear-gradient(to top, #FF6B35, #ff8c5a)',
            'linear-gradient(to top, #dc3545, #e8576a)',
            'linear-gradient(to top, #ffc107, #ffd454)',
            'linear-gradient(to top, #6f5ac8, #8a7cd8)',
            'linear-gradient(to top, #666, #888)'
        ];

        const chartData = [];
        order.forEach((label, index) => {
            const count = statusCounts[label] || 0;
            if (count > 0) {
                chartData.push({ label, count, color: colors[index] });
            }
        });

        if (chartData.length === 0) {
            container.innerHTML = '<div class="chart-placeholder">No career data available yet.</div>';
            return;
        }

        const maxCount = Math.max(...chartData.map(d => d.count));
        const maxHeight = 200;

        chartData.forEach(({ label, count, color }) => {
            const pct = total ? Math.round((count / total) * 100) : 0;
            const height = maxCount > 0 ? (count / maxCount) * maxHeight : 0;

            const barItem = document.createElement('div');
            barItem.className = 'chart-bar-item';
            barItem.innerHTML = `
                <div class="chart-bar" style="--bar-height: ${height}px; height: ${height}px; background: ${color};">
                    <div class="bar-value">${pct}%</div>
                </div>
                <div class="bar-label">${label}<br>(${count})</div>
            `;
            container.appendChild(barItem);
        });

        if (legendContainer) {
            chartData.forEach(({ label, count, color }) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background: ${color}"></div>
                    <span><strong>${label}:</strong> ${count}</span>
                `;
                legendContainer.appendChild(legendItem);
            });
        }
    }

    // Load on page ready
    document.addEventListener('DOMContentLoaded', () => {
        loadAlumniCareerOverview();
    });

    // Listen for career form submissions
    window.addEventListener('career:saved', () => {
        loadAlumniCareerOverview();
    });
</script>
